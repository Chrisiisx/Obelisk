DB Connection:
const { Pool } = require('pg');
require('dotenv').config();

const pool = new Pool({
    connectionString: process.env.DATABASE_URL,
    ssl: process.env.NODE_ENV === 'production' ? { rejectUnauthorized: false } : false
});

// Funzione helper per eseguire query
const query = (text, params) => pool.query(text, params);

module.exports = { query, pool };



================================================================================================




const express = require('express');
const router = express.Router();
const bcrypt = require('bcrypt');
const jwt = require('jsonwebtoken');
const { query } = require('../db'); // Assumi una connessione DB configurata

// Configurazioni
const SALT_ROUNDS = 12;
const JWT_SECRET = process.env.JWT_SECRET;

// Endpoint: POST /api/auth/register
router.post('/register', async (req, res) => {
    const { email, password } = req.body;

    // 1. Validazione base
    if (!email || !password) {
        return res.status(400).json({ error: 'Email e password obbligatorie' });
    }
    if (password.length < 8) {
        return res.status(400).json({ error: 'Password deve essere almeno 8 caratteri' });
    }

    try {
        // 2. Controlla se l'utente esiste già
        const existingUser = await query(
            'SELECT id FROM users WHERE email = $1',
            [email]
        );
        if (existingUser.rows.length > 0) {
            return res.status(409).json({ error: 'Email già registrata' });
        }

        // 3. Hash della password con bcrypt
        const passwordHash = await bcrypt.hash(password, SALT_ROUNDS);

        // 4. Genera una chiave master per l'utente (sul server, per ora solo placeholder)
        // IN FUTURO: questa sarà generata e cifrata lato client
        const masterKeyEncrypted = 'placeholder_for_future_client_side_key';

        // 5. Salva l'utente nel database
        const newUser = await query(
            `INSERT INTO users (email, password_hash, master_key_encrypted) 
             VALUES ($1, $2, $3) 
             RETURNING id, email, created_at`,
            [email, passwordHash, masterKeyEncrypted]
        );

        // 6. Genera un JWT per l'autenticazione automatica dopo la registrazione
        const token = jwt.sign(
            { userId: newUser.rows[0].id, email: newUser.rows[0].email },
            JWT_SECRET,
            { expiresIn: '7d' }
        );

        // 7. Rispondi con successo e token
        res.status(201).json({
            message: 'Utente registrato con successo',
            user: {
                id: newUser.rows[0].id,
                email: newUser.rows[0].email
            },
            token // Il frontend salverà questo token
        });

    } catch (error) {
        console.error('Errore registrazione:', error);
        res.status(500).json({ error: 'Errore interno del server' });
    }
});

module.exports = router;